<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Hair - AI Tech Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body class="chat-page">
    <div class="header">
        <h1>üß† Brain Hair - AI Tech Assistant</h1>
        <div class="context-info">
            <div class="context-item">
                <span class="context-label">Ticket:</span>
                <span class="context-value" id="current-ticket">None</span>
            </div>
            <div class="context-item">
                <span class="context-label">Client:</span>
                <span class="context-value" id="current-client">None</span>
            </div>
            <div class="context-item">
                <span class="context-label">User:</span>
                <span class="context-value">{{ user.preferred_username }}</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>Quick Actions</h3>
            <div class="quick-action" onclick="setContext('ticket')">
                üìã Set Ticket Number
            </div>
            <div class="quick-action" onclick="setContext('client')">
                üè¢ Set Client
            </div>
            <div class="quick-action" onclick="sendQuickMessage('List recent tickets')">
                üé´ List Recent Tickets
            </div>
            <div class="quick-action" onclick="sendQuickMessage('Search knowledge base')">
                üìö Search Knowledge
            </div>
            <div class="quick-action" onclick="sendQuickMessage('List client devices')">
                üíª List Devices
            </div>
            <div class="quick-action" onclick="clearChat()">
                üóëÔ∏è Clear Chat
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
            </div>

            <div class="typing-indicator" id="typing">
                <span>Claude is thinking</span>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea
                        class="input-field"
                        id="message-input"
                        placeholder="Ask me anything... (Shift+Enter for new line)"
                        rows="1"
                    ></textarea>
                    <button class="btn send-btn" id="send-btn" onclick="sendMessage()">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API endpoints (generated by Flask url_for)
        const API_CHAT = "{{ url_for('chat_message') }}";
        const API_COMMAND_APPROVE = "{{ url_for('approve_command') }}";
        const API_COMMAND_DENY = "{{ url_for('deny_command') }}";
        const API_SESSION_DELETE = "{{ url_for('destroy_session', session_id='SESSION_ID') }}".replace('SESSION_ID', '{session_id}');

        let currentTicket = null;
        let currentClient = null;
        let sessionId = null;
        let currentMessageElement = null;
        let currentMessageContent = '';

        // Auto-resize textarea
        const textarea = document.getElementById('message-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Send on Enter (but not Shift+Enter)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Clean up session when page unloads
        window.addEventListener('beforeunload', function() {
            if (sessionId) {
                const url = API_SESSION_DELETE.replace('{session_id}', sessionId);
                navigator.sendBeacon(url, JSON.stringify({_method: 'DELETE'}));
            }
        });

        function renderMarkdown(text) {
            // Parse markdown to HTML
            const html = marked.parse(text);
            // Sanitize HTML to prevent XSS
            return DOMPurify.sanitize(html);
        }

        function addMessage(role, content, streaming = false) {
            const messagesDiv = document.getElementById('messages');

            if (streaming && role === 'assistant' && currentMessageElement) {
                // Update existing streaming message
                const contentDiv = currentMessageElement.querySelector('.message-content');
                // Render markdown for assistant messages
                contentDiv.innerHTML = renderMarkdown(content);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                return currentMessageElement;
            }

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'AI';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Render markdown for assistant, plain text for user
            if (role === 'assistant') {
                contentDiv.innerHTML = renderMarkdown(content);
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (streaming && role === 'assistant') {
                currentMessageElement = messageDiv;
            }

            return messageDiv;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addMessage('user', message);

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            document.getElementById('typing').classList.add('active');
            document.getElementById('send-btn').disabled = true;

            // Reset streaming state
            currentMessageElement = null;
            currentMessageContent = '';

            try {
                // Use EventSource for Server-Sent Events streaming
                // Note: EventSource doesn't support POST, so we'll use fetch with streaming
                const response = await fetch(API_CHAT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        ticket: currentTicket,
                        client: currentClient
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Read the SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const {done, value} = await reader.read();

                    if (done) break;

                    // Decode the chunk
                    buffer += decoder.decode(value, {stream: true});

                    // Process complete SSE messages (separated by \n\n)
                    const messages = buffer.split('\n\n');
                    buffer = messages.pop(); // Keep incomplete message in buffer

                    for (const msg of messages) {
                        if (!msg.trim() || !msg.startsWith('data: ')) continue;

                        const dataStr = msg.substring(6); // Remove 'data: ' prefix

                        try {
                            const data = JSON.parse(dataStr);
                            handleSSEMessage(data);
                        } catch (e) {
                            console.error('Error parsing SSE message:', e, dataStr);
                        }
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', `‚ùå Error: ${error.message}`);
            } finally {
                document.getElementById('typing').classList.remove('active');
                document.getElementById('send-btn').disabled = false;
                input.focus();
                currentMessageElement = null;
            }
        }

        function handleSSEMessage(data) {
            switch (data.type) {
                case 'session_id':
                    // Store session ID for reuse
                    sessionId = data.session_id;
                    console.log('Session ID:', sessionId);
                    break;

                case 'thinking':
                    // Show what Claude is doing
                    const typingDiv = document.getElementById('typing');
                    typingDiv.querySelector('span').textContent = data.action || 'Claude is thinking';
                    typingDiv.classList.add('active');
                    break;

                case 'chunk':
                    // Hide typing indicator on first chunk
                    document.getElementById('typing').classList.remove('active');

                    // Append to current message content
                    currentMessageContent += data.content;

                    // Update or create message
                    addMessage('assistant', currentMessageContent, true);
                    break;

                case 'command_approval':
                    // Show command approval request
                    showCommandApproval(data.data);
                    break;

                case 'done':
                    // Stream complete - hide typing indicator
                    document.getElementById('typing').classList.remove('active');
                    currentMessageElement = null;
                    currentMessageContent = '';
                    break;

                case 'error':
                    // Error occurred - hide typing indicator
                    document.getElementById('typing').classList.remove('active');
                    addMessage('assistant', `‚ùå Error: ${data.error}`);
                    currentMessageElement = null;
                    currentMessageContent = '';
                    break;

                default:
                    console.warn('Unknown SSE message type:', data.type);
            }
        }

        function showCommandApproval(command) {
            const lastMessage = document.querySelector('.messages .message:last-child .message-content');
            const approvalDiv = document.createElement('div');
            approvalDiv.className = 'command-approval';
            approvalDiv.id = `approval-${command.id}`;
            approvalDiv.innerHTML = `
                <h4>‚ö†Ô∏è Command Approval Required</h4>
                <p><strong>Device ID:</strong> ${command.device_id}</p>
                <p><strong>Command:</strong></p>
                <div class="command-code">${escapeHtml(command.command)}</div>
                <p><strong>Purpose:</strong> ${escapeHtml(command.reason)}</p>
                <div class="command-buttons">
                    <button class="btn btn-approve" onclick="approveCommand('${command.id}')">
                        ‚úì Approve & Execute
                    </button>
                    <button class="btn btn-deny" onclick="denyCommand('${command.id}')">
                        ‚úó Deny
                    </button>
                </div>
            `;
            lastMessage.appendChild(approvalDiv);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function approveCommand(commandId) {
            try {
                // Disable buttons
                const approvalDiv = document.getElementById(`approval-${commandId}`);
                const buttons = approvalDiv.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);

                // Show executing message
                const statusMsg = document.createElement('p');
                statusMsg.style.marginTop = '0.5rem';
                statusMsg.style.color = '#f9e2af';
                statusMsg.innerHTML = '‚è≥ <strong>Executing command...</strong>';
                approvalDiv.appendChild(statusMsg);

                // Call backend to execute
                const response = await fetch(API_COMMAND_APPROVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        command_id: commandId
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Show output
                    statusMsg.innerHTML = '‚úÖ <strong>Command executed successfully!</strong>';
                    statusMsg.style.color = '#a6e3a1';

                    const outputDiv = document.createElement('div');
                    outputDiv.className = 'command-code';
                    outputDiv.style.marginTop = '0.5rem';
                    outputDiv.textContent = data.output;
                    approvalDiv.appendChild(outputDiv);

                    // Remove buttons
                    approvalDiv.querySelector('.command-buttons').remove();
                } else {
                    statusMsg.innerHTML = `‚ùå <strong>Error:</strong> ${data.error || 'Unknown error'}`;
                    statusMsg.style.color = '#f38ba8';
                    buttons.forEach(btn => btn.disabled = false);
                }

            } catch (error) {
                console.error('Error approving command:', error);
                addMessage('assistant', `‚ùå Error executing command: ${error.message}`);
            }
        }

        async function denyCommand(commandId) {
            try {
                // Call backend to deny
                await fetch(API_COMMAND_DENY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        command_id: commandId
                    })
                });

                // Update UI
                const approvalDiv = document.getElementById(`approval-${commandId}`);
                approvalDiv.innerHTML = '<p style="color: #f38ba8;">‚ùå <strong>Command denied by user</strong></p>';

                addMessage('assistant', 'Understood. Command cancelled. Is there another way I can help?');

            } catch (error) {
                console.error('Error denying command:', error);
            }
        }

        function setContext(type) {
            const value = prompt(`Enter ${type} ${type === 'ticket' ? 'number' : 'name'}:`);
            if (value) {
                if (type === 'ticket') {
                    currentTicket = value;
                    document.getElementById('current-ticket').textContent = value;
                    addMessage('assistant', `‚úì Context updated: Now working on ticket #${value}`);
                } else {
                    currentClient = value;
                    document.getElementById('current-client').textContent = value;
                    addMessage('assistant', `‚úì Context updated: Now viewing client ${value}`);
                }

                // Destroy old session since context changed
                if (sessionId) {
                    destroySession();
                }
            }
        }

        function sendQuickMessage(msg) {
            document.getElementById('message-input').value = msg;
            sendMessage();
        }

        async function destroySession() {
            if (sessionId) {
                try {
                    const url = API_SESSION_DELETE.replace('{session_id}', sessionId);
                    await fetch(url, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                } catch (error) {
                    console.error('Error destroying session:', error);
                }
                sessionId = null;
            }
        }

        function clearChat() {
            if (confirm('Clear chat history and start a new session?')) {
                // Destroy current session
                destroySession();

                // Clear UI
                document.getElementById('messages').innerHTML = '';
                currentMessageElement = null;
                currentMessageContent = '';

                // Reset context
                currentTicket = null;
                currentClient = null;
                document.getElementById('current-ticket').textContent = 'None';
                document.getElementById('current-client').textContent = 'None';

                // Show welcome message
                showWelcomeMessage();
            }
        }

        function showWelcomeMessage() {
            const welcomeText = `Hello! I'm your AI tech assistant. I can help you with:

- Looking up tickets and client information
- Searching the knowledge base
- Checking device status
- Running commands (with your approval)

What can I help you with today?`;
            addMessage('assistant', welcomeText);
        }

        // Initialize welcome message on page load
        document.addEventListener('DOMContentLoaded', function() {
            showWelcomeMessage();
        });
    </script>
</body>
</html>
